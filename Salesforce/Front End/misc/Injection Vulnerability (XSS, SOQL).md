Injection Vulnerability (XSS, SOQL)

# Overview

XSS (cross-site scripting) occurs when user input is not sanitized and is allowed to run a script on your site. SF has some built in protections and manual ones to keep in mind.

## XSS

Elements encased in HTML elements are automatically encoded to prevent XSS. This does **not** extend to multi-parsed contexts, script tags, or css.

### Built-in Protection

#### Exmaples

##### Safe

```html
<apex:outputText value="{!sampleMergeField2}" escape="false"/>
```

##### Unsafe

```html
<apex:outputText value="{!sampleMergeField1}"/>

<apex:outputText >
	{!sampleMergeField3}
</apex:outputText>

<style>
    .foo {
        color: #{!sampleMergeField4};
    }
</style>

{!sampleMergeField5}

<script>
    var x = '{!sampleMergeField6}';
</script>

<apex:outputLabel value="{!sampleMergeField7}" escape="false"/>
```

### Encoding Functions

SF provides functions to encode input in the uncovered contexts.

Function | Context
--- | --- | ---
JSENCODE() | Input parsed by JS parser
HTMLENCODE() | Input parsed by HTML parser
JSINHTMLENCODE() | Input parsed by both

#### JSENCODE()

##### Unsafe

```html
<script>
    var x = '{!$CurrentPage.parameters.userInput}';
</script>
```

##### Safe

```html
<script>
    var x = '{!JSENCODE($CurrentPage.parameters.userInput)}';
</script>
```

#### HTMLENCODE()

##### Unsafe

```html
<apex:outputText escape="false" value="<i>Hello {!Account.Name}</i>" />

<div id="test"></div>
<script>
    document.querySelector('#test').innerHTML='Howdy ' + '{!Account.Name}';
</script>
```

##### Safe

```html
<apex:outputText escape="false" value="<i>Hello {!HTMLENCODE(Account.Name)}</i>" />

<div id="test"></div>
<script>
    document.querySelector('#test').innerHTML='Howdy ' + '{!JSENCODE(HTMLENCODE(Account.Name))}';
</script>
```

#### JSINHTMLENCODE()

##### Unsafe

```html
<div onclick="console.log('{!JSINHTMLENCODE(Account.Name)}')">Click me!</div>
```

##### Safe

```html
<div onclick="console.log('{!JSENCODE(Account.Name)}')">Click me!</div>
```

## SOQL Injection

Again, unsanitized input is passed from the user and runs a query on our database

### Example

Search by supply__c Name form, but we inject and search for supplies marked for nobles only:

#### Intended Use

```
Venison
```

#### Exploit

```
%' and Nobles_Only__c = true and name like '%
```

### Prevention

#### Use Static Queries

Change the first to the second.

```apex
String query = ‘select id from contact where firstname =\’’+var+’\’’;
queryResult = Database.execute(query);
```

```apex
queryResult = [select id from contact where firstname =:var];
```

#### Typecasting

In the controller, change first to second.

```apex
public String textualAge {get; set;}
whereClause+='Age__c >'+textualAge+'';
```

```apex
public Integer textualAge {get; set;}
whereClause+='Age__c >'+string.valueOf(textualAge)+'';
```

#### Escape Sinlge Quotes Function

```apex
// Unsafe
whereClause += 'Title__c like  \'%'+textualTitle+'%\' ';

// Safe
whereClause += 'Title__c like  \'%'+string.escapeSingleQuotes(textualTitle)+'%\' ';
```

#### Replacing Characters

```apex
// unsafe
String query = ‘select id from user where isActive=‘+var;

// safe
String query = 'select id from user where isActive='+var.replaceAll('[^\w]','');
```

#### Allowlisting

Create a value of known "good" input values. Reject any input not in the list.